/*
*
* HlsPlayer.js v0.1.0
* Copyright (c) 2024-8-1 Ezviz-OpenBiz
* .
*
*/
import e,{Video as t}from"@ezuikit/player-base";import i from"@ezuikit/utils-collect";import n from"hls.js";import{addVc as s,getStaticPath as r}from"@ezuikit/utils-tools";import o from"@ezuikit/utils-logger";import{merge as a}from"lodash-es";import l from"eventemitter3";var u=1,h=2,c=3,d="aac",p="h265",f="hevc",m="m3u8",v="hls",g=0,y=1,_=600,T=400,w=30,P=40,C=!1,x=44100,S=20,L="ONCE",b="SWAP",R=0,D=265,E=1001,k=1002,M=1003;var A,I=function(){return window.WebAssembly&&"object"==("undefined"==typeof WebAssembly?"undefined":(e=WebAssembly)&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e);var e};function B(){return(new Date).getTime()}var F=window.AudioContext||(null==(A=window)?void 0:A.webkitAudioContext),N=function(){function e(e){var t=this;this.options={sampleRate:e.sampleRate||x,appendType:e.appendType||g,playMode:e.playMode||b,isLive:e.isLive},this.logger=null==e?void 0:e.logger,this.sourceChannel=-1,this.audioCtx=new F({latencyHint:"interactive",sampleRate:e.sampleRate}),this.gainNode=null,this.sourceList=[],this.startStatus=!1,this.sampleQueue=[],this.nextBuffer=null,this.playTimestamp=0,this.playStartTime=0,this.durationMs=-1,this.volume=e.volume||0,this.onLoadCache=null,this.sourceList.push(this.audioCtx.createBufferSource()),this.sourceList.push(this.audioCtx.createBufferSource()),this.sourceList[0].onended=function(){t.swapSource(0,1)},this.sourceList[1].onended=function(){t.swapSource(1,0)},this.gainNode=this.audioCtx.createGain(),this.gainNode.gain.value=this.volume,this.gainNode.connect(this.audioCtx.destination),this.runNextBuffer()}var t=e.prototype;return t.resetStartParam=function(){this.playTimestamp=0,this.playStartTime=0},t.setOnLoadCache=function(e){this.onLoadCache=e},t.setDurationMs=function(e){void 0===e&&(e=-1),this.durationMs=e},t.setVolume=function(e){void 0===e&&(e=0),this.volume=e,this.gainNode.gain.value=e},t.getAlignVPTS=function(){return this.playTimestamp+(B()-this.playStartTime)/1e3},t.swapSource=function(e,t){if(void 0===e&&(e=-1),void 0===t&&(t=-1),!this.startStatus)return null;if(e<0||e>=this.sourceList.length)return null;if(t<0||t>=this.sourceList.length)return null;try{this.sourceChannel===e&&null!==this.sourceList[e]&&(this.sourceList[e].disconnect(this.gainNode),this.sourceList[e]=null)}catch(t){this.logger.error("[DEFINE ERROR] this audioCore disconnect source Index:"+e+" error happened!",t)}(this.sourceChannel=t,-2===this.decodeSample(t,e)&&this.options.isLive)&&(this.getAlignVPTS()>=this.durationMs/1e3-.04?this.pause():null==this||this.onLoadCache());return null},t.addSample=function(e){return void 0===e&&(e=null),!(null==e||!e||void 0===e)&&(0===this.sampleQueue.length&&(this.seekPos=null==e?void 0:e.pts),this.sampleQueue.push(e),!0)},t.runNextBuffer=function(){var e=this;window.setInterval((function(){if(!(null!=e.nextBuffer||e.sampleQueue.length<S)){e.nextBuffer={data:null,pts:-1};for(var t=null,i=0;i<S;i++){t=e.sampleQueue.shift();var n=null;if(n=e.options.appendType===g?t:null==t?void 0:t.data,e.nextBuffer.pts<0&&(e.nextBuffer.pts=t.pts),null==e.nextBuffer.data)e.nextBuffer.data=new Uint8Array(n);else{var s=new Uint8Array(n.length+e.nextBuffer.data.length);s.set(e.nextBuffer.data,0),s.set(n,e.nextBuffer.data.length),e.nextBuffer.data=s}if(e.sampleQueue.length<=0)break;t=null}}}),10)},t.decodeSample=function(e,t){var i,n,s=this;if(void 0===e&&(e=-1),void 0===t&&(t=-1),e<0||e>=this.sourceList.length)return-1;if(null!=this.sourceList[e]&&void 0!==this.sourceList[e]&&this.sourceList[e]||(this.sourceList[e]=this.audioCtx.createBufferSource(),this.sourceList[e].onended=function(){s.swapSource(e,t)}),0===this.sampleQueue.length)return this.options.isLive?(this.sourceList[e].connect(this.gainNode),this.sourceList[e].startState||null==(n=this.sourceList[e])||null==(i=n.start)||i.call(n),this.sourceList[e].onended=function(){s.swapSource(e,t)},this.sourceList[e].stop(),0):-2;if(this.sourceList[e].buffer)return this.swapSource(e,t),0;if(null==this.nextBuffer||this.nextBuffer.data.length<1){var r,o,a=this.sourceList[e];return a.connect(this.gainNode),(null==a?void 0:a.startState)||null==(o=this.sourceList[e])||null==(r=o.start)||r.call(o),a.startState=!0,a.stop(),1}var l=this.nextBuffer.data.buffer;this.playTimestamp=this.nextBuffer.pts,this.playStartTime=B();try{this.audioCtx.decodeAudioData(l,(function(t){var i,n;null!==s.sourceList[e]&&(s.sourceList[e].buffer=t,s.sourceList[e].connect(s.gainNode),s.sourceList[e].startState||null==(n=s.sourceList[e])||null==(i=n.start)||i.call(n),s.sourceList[e].startState=!0)}),(function(e){s.logger.error("Error audioCore with decoding audio data",e)}))}catch(e){return this.nextBuffer=null,this.logger.log("decodeAudioData error",e),-3}return this.nextBuffer=null,0},t.decodeWholeSamples=function(e){var t=this;if(void 0===e&&(e=-1),this.sourceChannel=e,e<0||e>=this.sourceList.length)return-1;if(null!=this.sourceList[e]&&void 0!==this.sourceList[e]&&this.sourceList[e]||(this.sourceList[e]=this.audioCtx.createBufferSource(),this.sourceList[e].onended=function(){}),0===this.sampleQueue.length)return-2;for(var i=null,n=null,s=0;s<this.sampleQueue.length;s++){n=this.sampleQueue.shift();var r=null;if(r=this.options.appendType===g?n:n.data,null==i)i=new Uint8Array(r);else{var o=new Uint8Array(r.length+i.length);o.set(i,0),o.set(r,i.length),i=o}if(this.sampleQueue.length<=0)break;n=null}var a,l,u,h,c=i;if(null==c||c.length<1)return null==(a=this.sourceList[e])||a.connect(this.gainNode),this.sourceList[e].startState||null==(u=this.sourceList[e])||null==(l=u.start)||l.call(u),null==(h=this.sourceList[e])||h.stop(),1;var d=c.buffer;try{this.audioCtx.decodeAudioData(d,(function(i){var n,s,r;t.logger.warn("audioCore.sourceList ctx state before",t.sourceList[e].state),t.sourceList[e].buffer=i,null==(n=t.sourceList[e])||n.connect(t.gainNode),t.sourceList[e].startState||null==(r=t.sourceList[e])||null==(s=r.start)||s.call(r),t.sourceList[e].startState=!0,t.logger.warn("audioCore.sourceList ctx state after",t.sourceList[e].state)}),(function(e){return t.logger.error("DecodeAudioData error with decoding audio data"+(null==e?void 0:e.err)),new Error("DecodeAudioData error with decoding audio data"+(null==e?void 0:e.err))}))}catch(e){return this.logger.error("Crash[browser]! Please refresh your page"),-3}return 0},t.play=function(){if(this.logger.log("[AudioCore] play"),!this.startStatus){this.startStatus=!0;-2===(this.options.playMode===L?this.decodeWholeSamples(0):this.swapSource(0,1))&&this.pause()}},t.pause=function(){this.logger.log("[AudioCore] pause"),this.startStatus=!1;for(var e=0;e<this.sourceList.length;e++)if(void 0!==this.sourceList[e]&&null!==this.sourceList[e])try{var t,i;void 0!==(null==(t=this.sourceList[e])?void 0:t.buffer)&&null!==(null==(i=this.sourceList[e])?void 0:i.buffer)&&(this.sourceList[e].stop(),this.sourceList[e].disconnect(this.gainNode)),this.sourceList[e]=null}catch(e){this.logger.error("audio pause error ",e)}},t.stop=function(){this.pause(),this.cleanQueue(),this.nextBuffer=null,this.sourceChannel=-1},t.cleanQueue=function(){this.sampleQueue.length=0;for(var e=0;e<this.sourceList.length;e++)try{var t,i;void 0!==(null==(t=this.sourceList[e])?void 0:t.buffer)&&null!==(null==(i=this.sourceList[e])?void 0:i.buffer)&&(this.sourceList[e].stop(),this.sourceList[e].disconnect(this.gainNode)),this.sourceList[e]=null}catch(e){this.logger.error("[SAVE cleanQueue]===>",e)}},e}(),O=function(){function e(e){this.limit=e.limit||200,this.logger=null==e?void 0:e.logger,this.yuvCache=[]}var t=e.prototype;return t.appendCacheByCacheYuv=function(e){return this.yuvCache.push(e),this.yuvCache.length>=this.limit?(this.shiftYuv(),h):u},t.getState=function(){return this.yuvCache.length<=0?c:this.yuvCache.length>=this.limit?h:u},t.cleanPipeline=function(){this.yuvCache=[],this.yuvCache.length=0},t.shiftYuv=function(){return this.yuvCache.length<=0?null:this.yuvCache.shift()},e}(),U=function(){function e(e,t,i,n,s,r){this.pts=e,this.width=t,this.height=i,this.imageBufferY=n,this.imageBufferB=s,this.imageBufferR=r}return e.prototype.setYuv=function(e,t,i,n,s,r){this.pts=e,this.width=t,this.height=i,this.imageBufferY=n,this.imageBufferB=s,this.imageBufferR=r},e}(),$=function(){function e(e){this.gl=e,this.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}var t=e.prototype;return t.bind=function(e,t,i){var n=this.gl;n.activeTexture([n.TEXTURE0,n.TEXTURE1,n.TEXTURE2][e]),n.bindTexture(n.TEXTURE_2D,this.texture),n.uniform1i(n.getUniformLocation(t,i),e)},t.fill=function(e,t,i){var n=this.gl;n.bindTexture(n.TEXTURE_2D,this.texture),n.texImage2D(n.TEXTURE_2D,0,n.LUMINANCE,e,t,0,n.LUMINANCE,n.UNSIGNED_BYTE,i)},e}(),W=function(){function e(e,t){this.gl=null,this.gl=e.getContext("webgl")||e.getContext("experimental-webgl"),this.program=this.gl.createProgram();var i=["attribute highp vec4 aVertexPosition;","attribute vec2 aTextureCoord;","varying highp vec2 vTextureCoord;","void main(void) {"," gl_Position = aVertexPosition;"," vTextureCoord = aTextureCoord;","}"].join("\n"),n=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(n,i),this.gl.compileShader(n);var s=["precision highp float;","varying lowp vec2 vTextureCoord;","uniform sampler2D YTexture;","uniform sampler2D UTexture;","uniform sampler2D VTexture;","const mat4 YUV2RGB = mat4","("," 1.1643828125, 0, 1.59602734375, -.87078515625,"," 1.1643828125, -.39176171875, -.81296875, .52959375,"," 1.1643828125, 2.017234375, 0, -1.081390625,"," 0, 0, 0, 1",");","void main(void) {"," gl_FragColor = vec4( texture2D(YTexture, vTextureCoord).x, texture2D(UTexture, vTextureCoord).x, texture2D(VTexture, vTextureCoord).x, 1) * YUV2RGB;","}"].join("\n"),r=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(r,s),this.gl.compileShader(r),this.gl.attachShader(this.program,n),this.gl.attachShader(this.program,r),this.gl.linkProgram(this.program),this.gl.useProgram(this.program),this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS);var o=this.gl.getAttribLocation(this.program,"aVertexPosition");this.gl.enableVertexAttribArray(o);var a=this.gl.getAttribLocation(this.program,"aTextureCoord");this.gl.enableVertexAttribArray(a),this.verticesBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.verticesBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0]),this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(o,3,this.gl.FLOAT,!1,0,0),this.texCoordBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.texCoordBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(a,2,this.gl.FLOAT,!1,0,0),this.gl.y=new $(this.gl),this.gl.u=new $(this.gl),this.gl.v=new $(this.gl),this.gl.y.bind(0,this.program,"YTexture"),this.gl.u.bind(1,this.program,"UTexture"),this.gl.v.bind(2,this.program,"VTexture")}var t=e.prototype;return t.renderFrame=function(e,t,i,n,s){this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.y.fill(n,s,e),this.gl.u.fill(n>>1,s>>1,t),this.gl.v.fill(n>>1,s>>1,i),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)},t.destroyContext=function(){try{this.gl.deleteProgram(this.program),this.gl.deleteBuffer(this.verticesBuffer),this.gl.deleteBuffer(this.texCoordBuffer),this.gl.deleteTexture(this.gl.y.texture),this.gl.deleteTexture(this.gl.u.texture),this.gl.deleteTexture(this.gl.v.texture),this.gl=null,this.program=null,this.verticesBuffer=null,this.texCoordBuffer=null}catch(e){}},e}(),V=function(e,t){return{cmd:e,data:t}},j="wasmLoading",Y="wasmLoaded",H="wasmFailed",X="videoCallback",Q="decodeCodecContext",z="destroy",G="demuxTsStream",J="demuxCoreReceive",q="readPacket",K="readPacketEnd",Z="mediaInfo",ee="ezui-hls",te={width:600,height:400,volume:0,retry:20,autoPlay:!0,staticPath:"",isLive:!0,loggerOptions:{name:"HLS",level:"INFO",showTime:!0}},ie={disableContextmenu:!0},ne=function(){function e(e){void 0===e&&(e={}),this.options=Object.assign({},ie,e),this.logger=this.options.logger,this.event=this.options.event,this._classVideo=ee+"-video",this._$container=document.getElementById(this.options.id),this._render()}var i=e.prototype;return i._render=function(){var e,i;if("video"===this.options.nodeName)this.$video=new t(this._$container,this.options).$video;else{var n;if(this.$video=document.createElement(this.options.nodeName),this._$container.innerHTML="",this._$container.appendChild(this.$video),this.options.disableContextmenu)null==(n=this.$video)||n.addEventListener("contextmenu",(function(e){return e.preventDefault(),!1}));this.$video.classList.add(this._classVideo),this.$video.style.cssText+="object-fit: contain; z-index:1;"}null==(i=this.event)||null==(e=i.emit)||e.call(i,"rendered")},i._isVideo=function(){return"VIDEO"===this.$video.nodeName},i.destroy=function(){if(this.$video&&this._$container&&this.$video){try{this._$container.removeChild(this.$video)}catch(e){}this.$video=null}},e}();function se(e,t,i){return t&&function(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(e.prototype,t),e}function re(){return re=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},re.apply(this,arguments)}function oe(e,t){return oe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},oe(e,t)}var ae=function(e){function t(t){var i,n;return void 0===t&&(t={}),(i=e.call(this,re({nodeName:"canvas"},t))||this).options=Object.assign({},re({},t,{width:(null==t?void 0:t.width)||_,height:(null==t?void 0:t.height)||T,fps:(null==t?void 0:t.fps)||w,fixed:(null==t?void 0:t.fixed)||C,sampleRate:(null==t?void 0:t.sampleRate)||x,appendHevcType:(null==t?void 0:t.appendHevcType)||g,frameDurMs:(null==t?void 0:t.frameDurMs)||P,id:(null==t?void 0:t.id)||"",audioNone:(null==t?void 0:t.audioNone)||!1,videoCodec:(null==t?void 0:t.videoCodec)||R,type:"hls"})),i.logger=t.logger,i.frameList=[],i.cacheInterval=null,i.cacheYuvBuf=new O({logger:i.logger}),i.nowPacket=null,i.stream=new Uint8Array,i.vCodecID=D,i.audio=null,i.liveStartMs=-1,i.durationMs=-1,i.videoPTS=0,i.loop=null,i.cacheLoop=null,i.playParams={seekPos:-1,isLive:!!t.isLive,accurateSeek:!0,seekEvent:!1,realPlay:!0},i.calculateStartTime=-1,i.fix_poc_err_skip=0,i.frameTime=0,i.frameTimeSec=0,i.preCostTime=0,i._volume=(null==(n=i.options)?void 0:n.volume)||0,i.isPlaying=!1,i.isCaching=E,i.isNewSeek=!1,i.flushDecoder=0,i.isCheckDisplay=!1,i.isPlayLoadingFinish=0,i.vCachePTS=0,i.aCachePTS=0,i.noCacheFrame=0,i.decoderWorker=t.decoderWorker,i._onWorkerMessage(),i.onPlayingTime=null,i.onPlayingFinish=null,i.onLoadCache=null,i.onLoadCacheFinished=null,i.initVideoAndAudio(),i.cacheThread(),i}!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&oe(e,t)}(t,e);var i=t.prototype;return i.setSize=function(e,t){this.options.width=e||_,this.options.height=t||T},i.setFrameRate=function(e){void 0===e&&(e=25),this.options.fps=e,this.options.frameDurMs=1e3/e},i.setDurationMs=function(e){void 0===e&&(e=-1),this.durationMs=e,this.options.audioNone||this.audio.setDurationMs(e)},i.setPlayingCall=function(e){this.onPlayingTime=e},i.setVolume=function(e){var t;this._volume=e||0,this.options.audioNone||null==(t=this.audio)||t.setVolume(this._volume)},i.isPlayingState=function(){return this.isPlaying||this.isCaching===k},i.appendAACFrame=function(e){this.audio.addSample(e),this.aCachePTS=Math.max(e.pts,this.aCachePTS)},i.appendHevcFrame=function(e){this.options.appendHevcType===y&&(this.frameList.push(e),this.vCachePTS=Math.max(e.pts,this.vCachePTS))},i.getCachePTS=function(){return Math.max(this.vCachePTS,this.aCachePTS)},i.endAudio=function(){this.options.audioNone||this.audio.stop()},i.cleanSample=function(){this.options.audioNone||this.audio.cleanQueue()},i.cleanVideoQueue=function(){this.options.appendHevcType===g?this.stream=new Uint8Array:this.options.appendHevcType===y&&(this.frameList=[],this.frameList.length=0)},i.cleanCacheYUV=function(){this.cacheYuvBuf.cleanPipeline()},i.pause=function(){this.loop&&window.clearInterval(this.loop),this.loop=null,this.options.audioNone||this.audio.pause(),this.isPlaying=!1,this.isCaching===k&&(this.isCaching=M)},i.checkFinished=function(e){return!1},i.clearAllCache=function(){this.nowPacket=null,this.vCachePTS=0,this.aCachePTS=0,this.cleanSample(),this.cleanVideoQueue(),this.cleanCacheYUV()},i.getNalu1Packet=function(e){void 0===e&&(e=!0);var t=null,i=-1;if(this.options.appendHevcType===g)t=this.nextNalu();else{if(this.options.appendHevcType!==y)return null;var n=this.frameList.shift();if(!n)return null;t=n.data,i=n.pts,e&&(this.videoPTS=i)}return{nalBuf:t,pts:i}},i.cacheThread=function(){var e=this;this.cacheLoop=window.setInterval((function(){if(e.cacheYuvBuf.getState()!==h){var t=e.getNalu1Packet(!1);if(null!=t){var i=t.nalBuf,n=t.pts;i&&(e.decoderWorker.postMessage(V(Q,{nalBuf:i,pts:n,flushDecoder:e.flushDecoder})),e.flushDecoder=0)}}}),10)},i.stopCacheThread=function(){null!==this.cacheLoop&&(window.clearInterval(this.cacheLoop),this.cacheLoop=null)},i.loadCache=function(){var e=this;if(!(this.frameList.length<=3)){var t=this.isPlaying;if(this.cacheYuvBuf.yuvCache.length<=3)this.pause(),null==this||this.onLoadCache(),this.isCaching=t?k:M,null===this.cacheInterval&&(this.cacheInterval=window.setInterval((function(){var t,i;e.cacheYuvBuf.yuvCache.length>=1&&(null==(i=e)||null==(t=i.onLoadCacheFinished)||t.call(i),window.clearInterval(e.cacheInterval),e.cacheInterval=null,e.isCaching===k&&e.play(e.playParams),e.isCaching=E)}),40))}},i._playFunc=function(){var e=!1;if(B()-this.calculateStartTime>=this.frameTime-this.preCostTime){e=!0;var t=!0;if(this.calculateStartTime=B(),this.options.audioNone)this.playFrameYUV(t);else{this.fix_poc_err_skip>0&&(this.fix_poc_err_skip--,t=!1);var i=this.videoPTS-this.audio.getAlignVPTS();if(i>0)return void(this.playParams.seekEvent&&!this.options.audioNone&&this.audio.setVolume(0));if(t){if(!(t=-1*i<=1*this.frameTimeSec)){for(var n=parseInt(i/this.frameTimeSec+""),s=0;s<n;s++)this.playFrameYUV(!1);this.playFrameYUV(!0)}this.playFrameYUV(t)}}}return null==this||this.onPlayingTime(this.videoPTS),null==this||this.checkFinished(this.playParams.isLive),e},i.play=function(e){var t=this;if(this.playParams=e,this.calculateStartTime=B(),this.noCacheFrame=0,this.isPlaying=this.playParams.realPlay,this.options.isLive&&this.cacheYuvBuf.cleanPipeline(),this.loop&&(window.clearInterval(this.loop),this.loop=null),this.options.audioNone&&this.playParams.isLive){this.liveStartMs=B(),this.frameTime=Math.floor(1e3/this.options.fps),this.frameTimeSec=this.frameTime/1e3;var i=0;this.loop=window.setInterval((function(){var e=B()-t.liveStartMs,n=e/t.frameTime;t.logger.log("this.loop playFrameYUV ====>",e,n,i),n>=i&&(t.playFrameYUV(!0),i+=1)}),this.frameTime||5)}else(this.videoPTS>=this.playParams.seekPos&&!this.isNewSeek||0===this.playParams.seekPos||0===this.playParams.seekPos)&&(this.frameTime=1e3/this.options.fps,this.frameTimeSec=this.frameTime/1e3,this.options.audioNone||this.audio.play(),this._volume=this.options.audioNone?0:this.audio.volume,this.loop=window.setInterval((function(){var e=B();t._playFunc(),t.preCostTime=B()-e}),this.frameTime||5));return this.setVolume(this._volume),Promise.resolve()},i.stop=function(){this.destroy(),this.stream=new Uint8Array},i.destroy=function(){return void 0!==this.gl&&null!==this.gl&&(this.gl.destroyContext(),this.gl=null),this.endAudio(),this.cacheLoop&&window.clearInterval(this.cacheLoop),this.cacheLoop=null,this.loop&&window.clearInterval(this.loop),this.loop=null,this.pause(),this.decoderWorker.postMessage(V(z)),this.stream=null,this.frameList=null,this.durationMs=-1,this.videoPTS=0,this.isPlaying=!1,this.$video.remove(),!0},i.nextNalu=function(e){if(void 0===e&&(e=1),this.stream.length<=4)return!1;for(var t=-1,i=0;i<this.stream.length;i++){if(i+5>=this.stream.length){if(-1===t)return!1;var n=this.stream.subarray(t);return this.stream=new Uint8Array,n}var s="0 0 1"===this.stream.slice(0,3).join(" "),r="0 0 0 1"===this.stream.slice(0,4).join(" ");if(s||r){if(-1===t)t=i;else{if(e<=1){var o=this.stream.subarray(t,i);return this.stream=this.stream.subarray(i),o}e-=1}i+=3}}return!1},i.playFrameYUV=function(e){void 0===e&&(e=!1);var t=this.cacheYuvBuf.shiftYuv();if(!t)return this.noCacheFrame+=1,e&&!this.playParams.seekEvent&&this.loadCache(),!1;this.noCacheFrame=0;var i=t.pts;return this.videoPTS=i,this.drawImage(t.width,t.height,t.imageBufferY,t.imageBufferB,t.imageBufferR),t=null,e&&!this.playParams.seekEvent&&this.isPlaying&&this.loadCache(),!0},i.drawImage=function(e,t,i,n,s){this.$video.width===e&&this.$video.height===t||(this.$video.width=e,this.$video.height=t),this.isCheckDisplay||this.checkDisplaySize(e,t);var r=e*t,o=e/2*(t/2),a=new Uint8Array(r+2*o);a.set(i,0),a.set(n,r),a.set(s,r+o),this.gl.renderFrame(i,n,s,e,t),a=null},i.checkDisplaySize=function(e,t){var i,n=e/(null==(i=this.options)?void 0:i.width)>t/this.options.height,s=+(this.options.width/e).toFixed(2),r=+(this.options.height/t).toFixed(2),o=n?s:r,a=this.options.fixed,l=a?this.options.width:parseInt(e*o+""),u=a?this.options.height:parseInt(t*o+"");return this.$video.style.maxWidth="100%",this.$video.style.maxHeight="100%",this.options.width/this.options.height>=1&&l/u>=1?this.$video.style.width="100%":this.$video.style.height="100%",this.isCheckDisplay=!0,[l,u]},i._onWorkerMessage=function(){var e=this;this.decoderWorker.onmessage=function(t){var i=t.data;if(i.cmd===X){var n=i.data,s=n.ptsSec,r=n.strideY,o=n.height;n.width;var a=n.bufY,l=n.bufU,u=n.bufV,h=new U(s,r,o,a,l,u);e.cacheYuvBuf.appendCacheByCacheYuv(h),h=null}}},i.initVideoAndAudio=function(){this.$video.width=this.options.width,this.$video.height=this.options.height,this.gl=new W(this.$video,{preserveDrawingBuffer:!1}),this.options.audioNone||(this.audio=new N({logger:this.logger,sampleRate:this.options.sampleRate,appendType:this.options.appendHevcType,volume:this.options.volume,isLive:this.options.isLive})),this.isPlayLoadingFinish=1},se(t,[{key:"volume",get:function(){var e;return(null==(e=this.audio)?void 0:e.volume)||this._volume},set:function(e){this.setVolume(e)}}]),t}(ne),le=[/#EXT-X-PROGRAM-DATE-TIME.+\n/g],ue={lineDelimiter:/\r?\n/,extensionHeader:"#EXTM3U",tagPrefix:"#EXT",segmentPrefix:"#EXTINF",segmentParse:/^#EXTINF: *([0-9.]+)(, *(.+?)?)?$/,tagParse:/^#EXT-X-([A-Z-]+)(:(.+))?$/,version:"VERSION",allowCache:"ALLOW-CACHE",combined:"COMBINED",endList:"ENDLIST",targetDuration:"TARGETDURATION",mediaSequence:"MEDIA-SEQUENCE",discontinuity:"DISCONTINUITY",streamInf:"STREAM-INF",isComment:function(e){return e&&"#"===e[0]&&!e.startsWith(ue.tagPrefix)},isBlank:function(e){return""===e},canStrip:function(e){return ue.isBlank(e)||ue.isComment(e)},defaultMinDur:99999},he=function(){function e(e){this._retry=10,this.logger=null==e?void 0:e.logger,this.initState=!0,this.controller=new AbortController,this._slices=[],this._type=v,this._preURI="",this.duration=-1,this.onTransportStream=null,this.onFinished=null}var t=e.prototype;return t.destroy=function(){this.initState=!1},t.fetchM3u8=function(e){var t=this,i=this;if(this.initState){var n=function(t){return new Promise((function(i,n){var s=new XMLHttpRequest;s.open("GET",t),s.onload=function(){this.status>=200&&this.status<300&&(t!==this.responseURL?(e=this.responseURL,i(this.responseURL)):i(""))},s.onreadystatechange=function(){4===s.readyState&&200===s.status&&i(s.responseText)},s.onerror=function(){n(new Error("Network error."))},s.send()}))};n(e).then((function(s){if(t._retry=10,i._uriParse(e)){var r=i._m3u8Parse(s);if("number"==typeof r&&r>=0)var o=setTimeout((function(){i.fetchM3u8(e),clearTimeout(o)}),200*r)}return n=null,s})).catch((function(s){if(t.logger.error("[M3u8Base] fetch m3u8 url Error ==> ",s),n=null,t._retry>=1)var r=setTimeout((function(){i.fetchM3u8(e),clearTimeout(r)}),500);t._retry--}))}},t._uriParse=function(e){this._preURI="";var t=e.split("://"),i=null,n=null;if(t.length<1)return this.logger.log("HLS URI ERROR : "+e),!1;t.length>1?(i=t[0],n=t[1].split("/"),this._preURI=i+"://"):n=t[0].split("/");for(var s=0;s<n.length-1;s++)this._preURI+=n[s]+"/";return!0},t._m3u8Parse=function(e){for(var t,i=0;i<le.length;i++)e=e.replace(le[i],"");for(var n=e.split(ue.lineDelimiter),s=ue.defaultMinDur,r="",o=0;o<n.length;o++){var a=n[o];if(!(a.length<1)){if(null!=r&&""!==r)switch(r){case ue.version:case ue.mediaSequence:case ue.allowCache:case ue.discontinuity:case ue.targetDuration:case ue.combined:break;case ue.streamInf:return this.fetchM3u8(a),null;default:this.logger.log("Unknown beforeTag "+r)}var l=this._readTag(a);if(null!=l)switch(r=l.key,l.key){case ue.version:case ue.mediaSequence:case ue.allowCache:case ue.discontinuity:case ue.targetDuration:case ue.combined:case ue.streamInf:break;case ue.endList:if(this._type=m,null!=this.onFinished){var u={type:this._type,duration:this.duration};this.onFinished(u)}return!0;default:this.logger.log("unknow tag"+l.key)}var h=ue.segmentParse.exec(a);if(null!=h){var c=+h[1];this.duration+=parseFloat(h[1]),s>c&&(s=c);var d,p=n[o+=1],f=null;if(p.includes("http"))f=p;else{if("/"===p[0]){var v=this._preURI.split("//"),g=v[v.length-1].split("/");this._preURI=v[0]+"//"+g[0]}f=this._preURI+p}if(!this._slices.includes(f))this._slices.push(f),null==this||null==(d=this.onTransportStream)||d.call(this,f,c)}}}this._slices.length>500&&(this._slices=this._slices.slice(-500));var y={type:this._type,duration:-1};return null==this||null==(t=this.onFinished)||t.call(this,y),s},t._readTag=function(e){var t=ue.tagParse.exec(e);return null!==t?{key:t[1],value:t[3]}:null},e}(),ce=function(){function e(e){this.sampleRate=e.sampleRate,this.frameDurMs=Math.floor(1024e3/this.sampleRate),this.frameDurSec=this.frameDurMs/1e3}var t=e.prototype;return t.updateOptions=function(e){this.sampleRate=e.sampleRate,this.frameDurMs=1024e3/this.sampleRate,this.frameDurSec=this.frameDurMs/1e3},t._getPktLen=function(e,t,i){return((3&e)<<11)+(t<<3)+((224&i)>>5)},t.sliceAACFrames=function(e,t){for(var i=[],n=e,s=0;s<t.length-1;)if(255===t[s]&&t[s+1]>>4==15){var r=this._getPktLen(t[s+3],t[s+4],t[s+5]);if(r<=0)continue;var o=t.subarray(s,s+r),a=new Uint8Array(r);a.set(o,0),i.push({ptime:n,data:a}),n+=this.frameDurSec,s+=r}else s+=1;return i},e}(),de="M3U8",pe="TS",fe="FETCH",me=function(){function e(){}return e.init=function(t){e.collect=new i(t)},e.send=function(t,i){var n,s;null==(s=e.collect)||null==(n=s.send)||n.call(s,{action:t,logInfo:i})},e.updateParams=function(t){e.collect.updateExtendsInfo(t)},e}();function ve(e,t,i){return t&&function(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(e.prototype,t),e}var ge={sampleRate:0,sampleChannel:0,sample:0,fps:0,gop:0,vDuration:0,aDuration:0,duration:0,aCodec:"",vCodec:"",audioNone:!1,width:0,height:0},ye=function(){function e(e){this.logger=null==e?void 0:e.logger,this.event=null==e?void 0:e.event,this.decoderWorker=e.decoderWorker,this.options=e,this.mediaInfo=ge,this.controller=new AbortController,this._onWorkerMessage(),this.onReady=null,this.onDemuxed=null,this.onDemuxedFailed=null,this.aacDec=null}var t=e.prototype;return t.initDemuxer=function(){return this.logger.log("[MpegTsDemux] init demuxer on ready!"),null==this||this.onReady(),!0},t.demuxURL=function(e){this._demuxerTsInit(e)},t._demuxerTsInit=function(e){var t=this,i=this,n=this.controller.signal;fetch(e,{signal:n}).then((function(t){var n=t.headers.get("content-type");if("application/x-mpegURL"===n)throw i.logger.warn("fetch "+e+" response content type is "+n+"!"),me.send(100,{url:e,contentType:n}),new Error("fetch "+e+" Error");return t})).then((function(e){return e.arrayBuffer()})).then((function(n){n.fileStart=0;var s=new Uint8Array(n);s?i._demuxCore(s,e):t.logger.error("[MpegTsDemux] demuxerTsInit ERROR fetch res is null ==> ",e),s=null})).catch((function(n){var s,r,o,a;t.logger.error("[MpegTsDemux] demuxerTsInit ERROR fetch ERROR ==> ",n),null==(r=t.event)||null==(s=r.emit)||s.call(r,pe,{data:n}),null==(a=t.event)||null==(o=a.emit)||o.call(a,fe,{data:n,type:pe}),null==i||i.onDemuxedFailed(n,e),me.send(100,{url:e,msg:"fetch error"})}))},t._demuxCore=function(e,t){e.length<=0||this.decoderWorker.postMessage(V(G,{buff:e,tsUrl:t}))},t.readMediaInfo=function(){return this.mediaInfo},t.readAudioNone=function(){var e;return null==(e=this.mediaInfo)?void 0:e.audioNone},t.isHEVC=function(){return this.mediaInfo.vCodec===f||this.mediaInfo.vCodec===p},t.destroy=function(){this.controller&&this.controller.abort(),this.controller=null,this.mediaInfo=null,this.aacDec=null},t._onWorkerMessage=function(){var e=this;e.logger.log("[demuxer] register _onWorkerMessage"),e.decoderWorker.addEventListener("message",(function(t){var i=t.data;switch(i.cmd){case Z:var n,s;if(e.mediaInfo=i.data,e.mediaInfo)null==(s=e.event)||null==(n=s.emit)||n.call(s,"mediaInfo",e.mediaInfo);break;case J:var r;if(e.mediaInfo.vCodec)null==e.aacDec?e.aacDec=new ce(e.mediaInfo):e.aacDec.updateOptions(e.mediaInfo),null==e||null==(r=e.onDemuxed)||r.call(e)}}))},ve(e,[{key:"vCodec",get:function(){return this.mediaInfo.vCodec}}]),e}(),_e=function(){function e(e,t,i,n){this.pts=e,this.dts=e,this.isKey=t,this.data=i,this.video=n}return e.prototype.setFrame=function(e,t,i,n){this.pts=e,this.isKey=t,this.data=i,this.video=n},e}(),Te=function(){function e(e){this.logger=null==e?void 0:e.logger,this.event=null==e?void 0:e.event,this.decoderWorker=e.decoderWorker,this.m3u8Base=new he(e),this.mpegTsDemux=new ye(e),this.tsList=[],this._startTime=0,this._aStartTime=0,this.lockWait={state:!1,lockMember:{dur:0}},this._timerFeed=null,this.seekPos=-1,this.vPreFramePTS=0,this.aPreFramePTS=0,this.audioNone=!1,this.isHevcParam=!1,this.vCodec="",this.aCodec=null,this.aChannel=0,this.durationMs=-1,this.fps=-1,this.sampleRate=-1,this.size={width:-1,height:-1},this.mediaInfo=null,this._onWorkerMessage(),this.onReadyOBJ=null,this.onFinished=null,this.onDemuxed=null,this.onSamples=null,this.onCacheProcess=null}var t=e.prototype;return t.getCachePTS=function(){return Math.max(this.vPreFramePTS,this.aPreFramePTS)},t.demux=function(e){var t=this,i=this;this.vPreFramePTS=0,this.aPreFramePTS=0,this.m3u8Base.onTransportStream=function(e,t){i.tsList.push({streamURI:e,streamDur:t}),i.lockWait.state=!1},this.m3u8Base.onFinished=function(e){var t;e.type===m?i.durationMs=1e3*e.duration:i.durationMs=-1,null==i||null==(t=i.onFinished)||t.call(i,i.onReadyOBJ,e)},this.mpegTsDemux.onDemuxedFailed=function(e,n){t.logger.error("[M3u8] onDemuxedFailed: ",e,n),i.lockWait.state=!1},this.mpegTsDemux.onDemuxed=function(){var e;t.logger.log("[M3u8] onDemuxed"),null==i.mediaInfo&&(i.mediaInfo=i.mpegTsDemux.readMediaInfo(),t.logger.log("[M3u8] mediaInfo: ",i.mediaInfo),i.isHevcParam=i.mpegTsDemux.isHEVC(),i.vCodec=i.mpegTsDemux.vCodec,i.aCodec=i.mediaInfo.aCodec,i.aChannel=i.mediaInfo.sampleChannel,i.fps=i.mediaInfo.fps,i.sampleRate=i.mediaInfo.sampleRate,(null===i.aCodec||""===i.aCodec||i.aChannel<=0)&&(i.audioNone=!0),i.mediaInfo.width>0&&i.mediaInfo.height>0&&(t.size.width=t.mediaInfo.width,t.size.height=t.mediaInfo.height)),null==i||null==(e=i.onDemuxed)||e.call(i,i.onReadyOBJ),i.mpegTsDemux&&t.decoderWorker.postMessage(V(q))},this.mpegTsDemux.onReady=function(){i._fetchM3u8AndIntervalTs(e)},this._timerTsWasm=window.setInterval((function(){1===Ae.__HLS_WASM_DecoderState__&&(i._fetchM3u8AndIntervalTs(e),window.clearInterval(i._timerTsWasm),i._timerTsWasm=null)}),500)},t._fetchM3u8AndIntervalTs=function(e){var t=this,i=this;this.logger.log("[M3u8] start fetch m3u8 url"),i.m3u8Base.fetchM3u8(e),i._timerFeed=window.setInterval((function(){if(i.tsList.length>0&&!i.lockWait.state)try{var e=i.tsList.shift();if(null!=e){var n=e.streamURI,s=e.streamDur;i.lockWait.state=!0,i.lockWait.lockMember.dur=+s,i.mpegTsDemux.demuxURL(n)}else t.logger.error("[M3u8] onTsReady need wait ")}catch(e){var r,o,a,l;t.logger.error("[M3u8] onTsReady ERROR:",e),null==(o=t.event)||null==(r=o.emit)||r.call(o,de,{data:e}),null==(l=t.event)||null==(a=l.emit)||a.call(l,fe,{data:e,type:de}),i.lockWait.state=!1}}),50)},t.destroy=function(){var e;this.m3u8Base&&(null==(e=this.m3u8Base)||e.destroy(),this.m3u8Base=null);this._timerFeed&&(window.clearInterval(this._timerFeed),this._timerFeed=null),this.mpegTsDemux&&(this.mpegTsDemux.destroy(),this.mpegTsDemux=null)},t.bindReady=function(e){this.onReadyOBJ=e},t.getACodec=function(){return this.aCodec},t.getVCodec=function(){return this.vCodec},t.getDurationMs=function(){return this.durationMs},t.getFPS=function(){return this.fps},t.getSampleRate=function(){return this.sampleRate},t.getSampleChannel=function(){return this.aChannel},t.getSize=function(){return this.size},t._onWorkerMessage=function(){this.logger.log("[M3U8] register _onWorkerMessage");var e=this;e.decoderWorker.addEventListener("message",(function(t){var i=t.data;switch(i.cmd){case q:var n,s=i.data,r=s.type,o=s.pts,a=s.ptime,l=s.keyframe,u=s.data,h=s.layer;if(u=new Uint8Array(u),1===r&&e.mpegTsDemux.mediaInfo.aCodec===d&&(u=e.mpegTsDemux.aacDec.sliceAACFrames(a,u)),0===r){var c=function(e){var t=e.nalu,i=e.vlc.vlc;null==t.vps&&(t.vps=new Uint8Array);var n=new Uint8Array(t.vps.length+t.sps.length+t.pps.length+t.sei.length+i.length);return n.set(t.vps,0),n.set(t.sps,t.vps.length),n.set(t.pps,t.vps.length+t.sps.length),n.set(t.sei,t.vps.length+t.sps.length+t.pps.length),n.set(i,t.vps.length+t.sps.length+t.pps.length+t.sei.length),n}(h),p=o,f=new _e(p,1===l,c,!0);e.vPreFramePTS=p,null==e||e.onSamples(e.onReadyOBJ,f)}else if(1===r){var m;if("aac"===(null==(m=e.mediaInfo)?void 0:m.aCodec)){for(var v=u,g=0;g<v.length;g++){var y=v[g],_=o,T=new _e(_,!0,y.data,!1);e.aPreFramePTS=_,null==e||e.onSamples(e.onReadyOBJ,T)}v=[]}else{var w,P=o,C=new _e(P,!0,u,!1);e.aPreFramePTS=P,null==e||null==(w=e.onSamples)||w.call(e,e.onReadyOBJ,C)}}null==e||null==(n=e.onCacheProcess)||n.call(e,e.getCachePTS());break;case K:e.lockWait.state=!1}}))},e}();function we(e,t,i){return t&&function(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(e.prototype,t),e}function Pe(){return Pe=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},Pe.apply(this,arguments)}function Ce(e,t){return Ce=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Ce(e,t)}var xe=function(e){function t(t){var i;return(i=e.call(this,Pe({nodeName:"video"},t))||this)._options=Object.assign({},t),i.event=i._options.event,i.logger=i._options.logger,i._volume=i._options.volume||0,i._init(),i._onEvent(),i}!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ce(e,t)}(t,e);var i=t.prototype;return i._init=function(){var e=this;if(this.$video.style.width="100%",this.$video.style.height="100%",this._options.autoPlay&&(this.$video.muted=!0,this.$video.preload="auto",this.$video.autoplay=!0),n.isSupported()){var t=this;this.logger.log("Browser support hls.js"),this._hls=new n({debug:{log:function(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];var s,r;return null==(r=t._options.logger)?void 0:(s=r).log.apply(s,[].concat(i))},warn:function(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];var s,r;return null==(r=t._options.logger)?void 0:(s=r).warn.apply(s,[].concat(i))},info:function(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];var s,r;return null==(r=t._options.logger)?void 0:(s=r).info.apply(s,[].concat(i))},error:function(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];var s,r;return null==(r=t._options.logger)?void 0:(s=r).error.apply(s,[].concat(i))}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:10,retryDelayMs:0,maxRetryDelayMs:6e3},errorRetry:{maxNumRetry:5,retryDelayMs:1e3,maxRetryDelayMs:6e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:5,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:4e3},errorRetry:{maxNumRetry:5,retryDelayMs:1e3,maxRetryDelayMs:4e3}}},nudgeMaxRetry:10}),this._hls.attachMedia(this.$video),this._hls.on(n.Events.MEDIA_ATTACHED,(function(){e._hls.loadSource(e._options.url),e._hls.on(n.Events.MANIFEST_PARSED,(function(t,i){e._options.autoPlay&&e.$video.play().then((function(){setTimeout((function(){e._options.volume>0&&(e.$video.volume=e._options.volume)}),1e3)})),e.event.emit("parsed")}))}))}else if(this.$video.canPlayType("application/vnd.apple.mpegurl")){this.logger.log("Browser support application/vnd.apple.mpegurl : ",this.$video.canPlayType("application/vnd.apple.mpegurl")),this.$video.src=this._options.url;var i=!1;this.$video.addEventListener("canplay",(function(){!i&&e._options.autoPlay&&setTimeout((function(){e.$video.play().then((function(){e.logger.log("autoPlay video!"),setTimeout((function(){e._options.volume>0&&e.setVolume(e._options.volume)}),1e3),i=!0}))}),200)}))}else this.logger.warn("Browser not support hls")},i.isPlayingState=function(){return!this.$video.paused},i.play=function(){if(this.isPlayingState())return Promise.resolve();if(this._options.isLive&&(this.$video.buffered.length>=1&&this.$video.buffered.end(0)>1)){var e=this.$video.buffered.end(0)-1;this.$video.currentTime=e}return this.$video.play()},i.pause=function(){this.$video.pause()},i.setVolume=function(e){this.$video.muted&&(this.$video.muted=!1),this._volume=+(e||0),0===this._volume&&(this.$video.muted=!0),this.$video.volume=this._volume},i.destroy=function(){this.$video&&this.$video.pause(),this._hls&&(this._hls.destroy(),this._hls=null),e.prototype.destroy.call(this)},i._onEvent=function(){var e;(e=this).$video&&(e.$video.addEventListener("canplay",(function(){e.event.emit("canplay")})),e.$video.addEventListener("loadeddata",(function(){e.event.emit("loadeddata")})),e.$video.addEventListener("volumechange",(function(){e.event.emit("volumechange",{data:e.$video.volume})})),e.$video.addEventListener("waiting",(function(){e.event.emit("waiting")})),e.$video.addEventListener("timeupdate",(function(){var t;null==(t=e.event)||t.emit("timeupdate")})),e.$video.addEventListener("seeking",(function(){e.event.emit("seeking",{data:e.$video.currentTime})})),e.$video.addEventListener("seeked",(function(){e.event.emit("seeked")})),e.$video.addEventListener("abort",(function(){e.event.emit("abort")})),e.$video.addEventListener("error",(function(){var t;null==(t=e.event)||t.emit("error",{data:e.$video.error})})),e.$video.addEventListener("ended",(function(){e.event.emit("ended")})))},we(t,[{key:"volume",get:function(){return this._volume},set:function(e){this.setVolume(e)}}]),t}(ne);var Se="wasm_loaded",Le="wasm_failed",be="init";function Re(e,t){return Re=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Re(e,t)}var De=function(e){function t(t){var i;return void 0===t&&(t={}),i=e.call(this,t)||this,t.url=s(null==t?void 0:t.url,["h264","h265"]),function(e,t){if(((null==t?void 0:t.volume)||0)>1?e._volume=1:((null==t?void 0:t.volume)||0)<=0?e._volume=0:e._volume=+((null==t?void 0:t.volume)||0),t.volume=e._volume,e.options=a({},te,t),"string"!=typeof e.options.id)throw new Error("id is required!");e.logger=o(e.options.loggerOptions),e.event=new l,e.logger.log("HlsPlayer version: ",Ae.version),e.logger.log("HlsPlayer options: ",e.options),e.options.logger=e.logger}(function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(i),t),i._containerClassName=ee+"-container",i._render(),i}!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Re(e,t)}(t,e);var i=t.prototype;return i._render=function(){this.$container.classList.add(this._containerClassName)},i.destroy=function(){this.$container&&(this.$container.classList.remove(this._containerClassName),this.$container.innerHTML="",this.$container=null)},t}(e);function Ee(e,t,i){return t&&function(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(e.prototype,t),e}function ke(){return ke=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},ke.apply(this,arguments)}function Me(e,t){return Me=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Me(e,t)}var Ae=function(e){function t(t){var i;return i=e.call(this,t)||this,me.init({url:"https://log.ys7.com/statistics.do/opensdk_ezuikit",forbidden:i.options.disableCollect,extendsInfo:{protocol:"hls",v:"0.1.0",url:i.options.url}}),me.send(1,{name:"constructor"}),i.event.emit(be),i._decoderWorker=new Worker((""===i.options.staticPath?"":r(i.options.staticPath))+(i.options.decoder||"decoder.worker.js")),i._m3u8Obj=null,i.url=i.options.url,i.playParam=null,i.player=null,i.onPlayTime=null,i.onParsed=null,i.onSeekStart=null,i.onLoadCache=null,i.onLoadCacheFinished=null,i.onPlayFinish=null,i.onCacheProcess=null,i.onReadyShowDone=null,i.onError=null,i._init(),i}!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Me(e,t)}(t,e);var i=t.prototype;return i._init=function(){var e=!1;if(this.options.volume>0&&(e=!0),this.playParam={durationMs:0,fps:0,sampleRate:0,size:{width:0,height:0},audioNone:e,videoCodec:R},!I())throw new Error("Browser not support WebAssembly!");this._onWorkerMessage()},i.play=function(){if(me.send(1,{name:"play"}),null===this.player)return Promise.resolve();if(this.playParam.videoCodec===R){var e={seekPos:0,isLive:this.options.isLive,accurateSeek:!0,seekEvent:!1,realPlay:!0};return this.player.play(e)}return this.player.play()},i.pause=function(){return me.send(1,{name:"pause"}),null!==this.player&&(this.player.pause(),!0)},i.destroy=function(){var t,i;return me.send(1,{name:"destroy"}),void 0!==this.player&&null!==this.player&&(this.playParam.videoCodec===R&&this._m3u8Obj&&(this._m3u8Obj.destroy(),this._m3u8Obj=null),this.player.destroy(),this._decoderWorker&&(this._decoderWorker.postMessage(V(z)),this._decoderWorker.terminate(),this._decoderWorker=null),this.logger.log("destroy"),null==(i=this.event)||null==(t=i.emit)||t.call(i,"destroy"),this.player=null,e.prototype.destroy.call(this),!0)},i.isPlaying=function(){return null!==this.player&&this.player.isPlayingState()},i.setVolume=function(e){var t;(e=+e)>1||e<0?this.logger.warn("volume volume value 0.0 ~ 1.0!"):((t=this).player||(t.event.emit("playerIsNull"),t.logger.warn("Player instance does not exist!"),0))&&(this.player.setVolume(e),this.event.emit("volumeChange",{data:e}))},i.getVersion=function(){return me.send(1,{name:"getVersion"}),"0.1.0"},i._m3u8Entry=function(){var e=this;this._m3u8Obj=new Te({logger:this.logger,decoderWorker:this._decoderWorker,event:this.event}),this._m3u8Obj.bindReady(this),this._m3u8Obj.onFinished=function(e,t){},this._m3u8Obj.onCacheProcess=function(t){e.options.isLive||null==e.onCacheProcess||e.onCacheProcess.call(e,t)},this._m3u8Obj.onDemuxed=this._checkPlayer.bind(this),this._m3u8Obj.onSamples=this._hlsOnSamples.bind(this),this._m3u8Obj.demux(this.url)},i._checkPlayer=function(e,t){var i=this;if(null==i.player){var n,s,r;if(!(null==i||null==(n=i._m3u8Obj)?void 0:n.isHevcParam)||t)return null==i||null==(r=i._m3u8Obj)||null==(s=r.destroy)||s.call(r),i._m3u8Obj=null,this._decoderWorker.terminate(),this._decoderWorker=null,void(i.player=new xe(ke({},this.options,{event:this.event,logger:this.logger})));var o=i._m3u8Obj.getACodec(),a=i._m3u8Obj.getFPS(),l=i._m3u8Obj.getSampleRate(),u=i._m3u8Obj.getSize(),h=!1;h=i._m3u8Obj.getSampleChannel()<=0||""===o,i._softPlayer(0,a,l,u,h)}},i._hlsOnSamples=function(e,t){var i,n,s,r=this;if(t.video)null==(s=r.player)||null==(n=s.appendHevcFrame)||n.call(s,t);else if(!(null==(i=r._m3u8Obj)?void 0:i.audioNone)){var o,a;null==(a=r.player)||null==(o=a.appendAACFrame)||o.call(a,t)}},i._onWorkerMessage=function(){var e=this,i=this;this._decoderWorker.onmessage=function(n){var s=n.data;switch(s.cmd){case j:t.__HLS_WASM_DecoderState__=0;break;case Y:t.__HLS_WASM_DecoderState__=1,e.logger.log("Wasm already init over!"),i.event.emit(Se),i._decoderWorker.postMessage(V("registerWasmPlayer")),i._m3u8Entry();break;case H:t.__HLS_WASM_DecoderState__=-1,e.logger.error("Wasm init failed!",s),i.event.emit(Le,s),me.send("wasm",{name:"wasm loading failed"}),i._checkPlayer(!0)}}},i._softPlayer=function(e,t,i,n,s,r){var o,a,l=this;void 0===s&&(s=!1),void 0===r&&(r=null);var u,h=this;(this.playParam.durationMs=e,this.playParam.fps=t,this.playParam.sampleRate=i,this.playParam.size=n,this.playParam.audioNone=s,this.playParam.videoCodec=r||R,this.logger.log("this.playParam: ",this.playParam),this.logger.log("start init soft player"),this.player=new ae(ke({},h.options,{sampleRate:i,fps:t,appendHevcType:y,fixed:!1,id:this.options.id,audioNone:s,videoCodec:r,logger:this.logger,event:this.event,decoderWorker:this._decoderWorker})),this.player.onPlayingTime=function(e){var t;null==h||null==(t=h.onPlayTime)||t.call(h,e)},this.player.onPlayingFinish=function(){var e,t;(l.pause(),null!=l.onPlayFinish)&&(null==(t=l)||null==(e=t.onPlayFinish)||e.call(t))},this.player.onLoadCache=function(){var e,t;null==(t=l)||null==(e=t.onLoadCache)||e.call(t)},this.player.onLoadCacheFinished=function(){var e,t;null==(t=l)||null==(e=t.onLoadCacheFinished)||e.call(t)},null==(o=h.player)||o.setDurationMs(e),null==(a=h.player)||a.setFrameRate(t),null!=h.onReadyShowDone)&&(null==h||null==(u=h.onReadyShowDone)||u.call(h));this.event.emit("parsed"),this.player&&this.options.autoPlay&&this.play()},t.supportType=function(e){if(me.send(1,{name:"supportType",options:e}),"hls"===e.type)return!0;if(e.url){var t=e.url;t.startsWith("http://")||t.startsWith("https://")||(t=/^\/\//.test(t)?"http:"+t:location.origin+location.pathname+t);try{return/\.m3u8$/i.test(new URL(t).pathname)}catch(e){}}return!1},Ee(t,[{key:"volume",get:function(){return this.player?this.player.volume:this.options.volume},set:function(e){e=+e,this.setVolume(e)}}]),t}(De);Ae.__HLS_WASM_DecoderState__=0,Ae.version="0.1.0";export{Ae as default};
